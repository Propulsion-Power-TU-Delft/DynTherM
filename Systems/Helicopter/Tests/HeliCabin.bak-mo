within DynTherM.Systems.Helicopter.Tests;
model HeliCabin
  Components.MassTransfer.SourceMassFlow leakInCabin(
    use_in_massFlow=false,
    use_in_T=false,
    use_in_Xw=false,
    allowFlowReversal=false,
    massFlow_nom=0.1,
    use_di_T=true,
    use_di_Xw=true,
    T_di=environment.T_amb,
    Xw_di=environment.X_amb[1])  "air mass entering"
    annotation (Placement(transformation(extent={{-72,18},{-52,38}})));
  Components.MassTransfer.SourceMassFlow leakOutCabin(
    use_di_T=true,
    use_di_Xw=true,
    T_di=heliCabin.plenum.T,
    Xw_di=heliCabin.plenum.X[1],
    allowFlowReversal=true,
    massFlow_nom=-0.1)
    annotation (Placement(transformation(extent={{42,2},{22,22}})));
  Components.MassTransfer.SourceMassFlow airTransferCabin(
    use_in_massFlow=false,
    use_in_T=false,
    use_in_Xw=false,
    massFlow_nom=-0.069,
    use_di_T=true,
    use_di_Xw=true,
    allowFlowReversal=true,
    T_di=T_transfer,
    Xw_di=X_transfer)
    annotation (Placement(transformation(extent={{42,-12},{22,8}})));
  NH90.AdvancedModels.HeliCabin
            heliCabin(
    redeclare model HTC_int = HTC_int,
    redeclare model HTC_ext = HTC_ext_cb,
    redeclare model HTC_floor = HTC_floor,
    redeclare model HTC_duct = HTC_duct,
    redeclare model HTC_engine = HTC_engine,
    redeclare model HTC_btp = HTC_btp,
    N_occupants=N_occupants,
    m_cabin=1,
    redeclare model Fuselage_int = Materials.AirbusEES.Fuselage,
    redeclare model Fuselage_core = Materials.FibrelamAramid6100,
    redeclare model Fuselage_ext = Materials.AirbusEES.Fuselage,
    csi_fus=1.3962634015955)
    annotation (Placement(transformation(extent={{-10,26},{10,46}})));
  Subsystems.Evaporator evaporatorCabin(
    m_fan=m_fan_cb,
    T_start_out=T_start_cb,
    X_start_out=X_start_cb)
    annotation (Placement(transformation(extent={{-8,-38},{12,-18}})));
  Components.MassTransfer.SourceMassFlow extAirCb(
    allowFlowReversal=false,
    use_di_T=true,
    use_di_Xw=true,
    use_di_massFlow=true,
    massFlow_di=m_ext_cb,
    T_di=environment.T_amb,
    Xw_di=environment.X_amb[1])
    annotation (Placement(transformation(extent={{42,-42},{24,-24}})));
  Components.MassTransfer.PressureSink pressureSinkCabin
    annotation (Placement(transformation(extent={{50,18},{70,38}})));
  inner Components.Environment environment(
    ISA_plus=0,
    P_amb_di(displayUnit="bar"),
    use_T_amb=true,
    use_ext_sw=true,
    initOpt=DynTherM.Choices.InitOpt.fixedState,
    Altitude=2000,
    phi_amb=0.4,
    T_ground=313.15,
    use_P_amb=true)
    annotation (Placement(transformation(extent={{70,70},{100,100}})));
  Modelica.Blocks.Sources.Constant floorTemp(k=323.15)
    annotation (Placement(transformation(extent={{-80,60},{-60,80}})));
  Modelica.Blocks.Sources.Constant engineTemp(k=373.15)
    annotation (Placement(transformation(extent={{-10,-10},{10,10}},
        rotation=0,
        origin={-30,90})));
  Modelica.Blocks.Sources.Constant transmissionTemp(k=353.15)
    annotation (Placement(transformation(extent={{40,60},{20,80}})));
equation
  connect(leakOutCabin.outlet,heliCabin. outletPort) annotation (Line(points={{22,12},
          {14,12},{14,27.6},{2,27.6}},           color={0,0,0}));
  connect(airTransferCabin.outlet,heliCabin. outletPort) annotation (Line(
        points={{22,-2},{14,-2},{14,27.6},{2,27.6}},       color={0,0,0}));
  connect(leakInCabin.outlet,heliCabin. inletPort) annotation (Line(points={{-52,28},
          {-27.5,28},{-27.5,27.6},{-3,27.6}},      color={0,0,0}));
  connect(evaporatorCabin.plenumTemp,heliCabin. plenumTemp) annotation (Line(
        points={{-8,-19},{-12,-19},{-12,28},{-18,28},{-18,40},{-11,40}},
                                                                  color={0,0,127}));
  connect(evaporatorCabin.outletPort,heliCabin. inletPort) annotation (Line(
        points={{-7,-33},{-16,-33},{-16,27.6},{-3,27.6}},
                                                      color={0,0,0}));
  connect(evaporatorCabin.thermalPort,heliCabin. ductThermalPort) annotation (
      Line(points={{-7.4,-28},{-40,-28},{-40,14},{10.1,14},{10.1,31.3}},
        color={191,0,0}));
  connect(evaporatorCabin.inletPortRecirc,heliCabin. outletPort) annotation (
      Line(points={{11,-29},{18,-29},{18,-14},{2,-14},{2,27.6}},
                                                       color={0,0,0}));
  connect(extAirCb.outlet,evaporatorCabin. inletPortFresh)
    annotation (Line(points={{24,-33},{18,-33},{18,-33.4},{11,-33.4}},
                                                               color={0,0,0}));
  connect(pressureSinkCabin.inlet,heliCabin. outletPort) annotation (Line(
        points={{50,28},{18,28},{18,27.6},{2,27.6}},                  color=
         {0,0,0}));
  connect(floorTemp.y, heliCabin.floorTempInput) annotation (Line(points={{-59,
          70},{-5.3,70},{-5.3,45.9}}, color={0,0,127}));
  connect(engineTemp.y, heliCabin.engineTempInput)
    annotation (Line(points={{-19,90},{0.9,90},{0.9,45.7}}, color={0,0,127}));
  connect(transmissionTemp.y, heliCabin.transmissionTempInput)
    annotation (Line(points={{19,70},{5.1,70},{5.1,45.7}}, color={0,0,127}));
  annotation (Icon(coordinateSystem(preserveAspectRatio=false)), Diagram(
        coordinateSystem(preserveAspectRatio=false)));
end HeliCabin;
